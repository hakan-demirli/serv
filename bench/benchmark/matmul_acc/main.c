#include <zephyr.h>
#include <sys/printk.h>
#include <kernel.h>
#include "mat_mul_adr.h"
#include "s_gpio.h"

#define ADR_TIMER_BASE 0x80000000
#define TMR(x)   (*(volatile uint32_t *)(x))

union printable_integer {
/* %d and %x are not working for printk*/
    int   myint;
    uint32_t   myuint;
    struct {
        char char1;
        char char2;
        char char3;
        char char4;
    } myChars;
};

void main(void)
{
	union printable_integer p_int;
	static int DATA_0[16][16] = {{57,103,130,117,174,68,28,248,121,225,199,189,142,159,157,70},
		        {141,65,27,158,100,98,192,198,63,177,185,221,221,71,52,240},
		        {14,123,22,81,194,42,167,123,156,141,243,61,203,26,221,5},
		        {106,169,141,95,22,44,79,74,92,138,244,43,238,100,24,97},
		        {156,16,7,180,27,111,90,172,242,188,210,148,156,185,72,133},
		        {235,179,157,105,178,152,137,244,52,5,253,183,88,3,163,84},
		        {250,179,154,162,182,18,45,47,14,243,12,231,143,30,22,183},
		        {60,89,140,245,108,63,140,164,117,141,237,167,164,142,46,79},
		        {157,44,248,148,72,242,30,135,109,234,121,25,159,72,152,100},
		        {142,183,30,154,160,212,140,88,70,58,219,89,216,57,227,178},
		        {147,127,193,240,73,31,117,211,76,58,241,109,235,49,8,228},
		        {131,130,11,205,66,89,138,98,109,163,43,114,2,32,98,5},
		        {252,34,179,11,166,162,227,82,88,193,86,212,137,39,198,101},
		        {64,20,143,172,18,119,75,250,42,239,119,189,27,233,92,132},
		        {106,147,0,232,93,108,91,252,244,101,127,212,113,23,156,97},
		        {174,31,198,185,207,125,13,204,15,176,203,50,52,43,28,57}};
                
	static int DATA_1[16][16] = {{187,128,82,208,39,206,92,215,94,247,32,227,240,117,91,27},
		        {34,247,38,181,210,247,207,224,173,235,238,133,120,82,111,253},
		        {27,146,215,164,46,247,153,135,81,173,103,143,115,208,215,254},
		        {137,79,33,27,141,71,136,242,83,204,247,155,62,11,67,121},
		        {17,180,148,146,51,213,220,161,236,85,196,149,155,243,175,172},
		        {75,36,170,184,37,176,176,10,164,88,17,94,250,216,202,194},
		        {161,116,235,222,21,231,177,165,57,74,50,40,159,0,31,224},
		        {131,231,168,84,242,31,190,220,109,152,52,14,164,122,86,251},
		        {52,32,210,139,121,239,204,103,243,82,52,95,222,2,182,229},
		        {105,21,19,167,192,211,172,70,97,34,1,144,59,112,108,2},
		        {220,221,157,67,102,42,178,42,181,141,169,165,118,69,238,4},
		        {194,235,130,144,92,199,83,181,76,41,102,68,44,184,16,11},
		        {190,159,229,222,106,152,55,209,64,147,213,30,237,242,120,188},
		        {143,69,245,244,12,151,26,172,247,162,11,180,37,95,219,93},
		        {108,208,175,137,40,95,73,1,7,193,234,2,215,34,36,19},
		        {200,248,214,63,189,240,98,93,50,222,19,41,86,118,33,241}};
                
	static int DATA_2[16][16] = {{269790,335820,325381,311124,250321,340457,309449,303538,278833,291037,247672,225919,288585,267684,275322,278785},
		        {328046,348992,337727,312840,255870,363032,298784,326499,238802,302068,224793,209947,300348,262499,226722,300077},
		        {223306,283271,283108,266726,191491,281911,276989,234173,228113,236099,256355,167278,284294,192206,223878,240318},
		        {231285,258865,260097,258397,194015,284871,236308,249122,211608,258261,204257,193998,239790,200257,231569,242188},
		        {298078,276601,322470,298577,231331,328191,280349,290335,270526,283328,192600,225259,292621,211252,257178,259544},
		        {283046,384900,330577,313985,227063,352734,330235,320027,260366,335562,271885,232383,342815,270666,262132,311358},
		        {241167,298235,236805,288055,221344,372407,259896,313942,206546,282359,213125,230204,241301,261964,193411,247904},
		        {279837,308651,317103,292452,229108,328435,297450,316419,261927,288127,247875,229053,268429,233164,262565,286475},
		        {238346,262884,305910,304254,209022,342979,288626,253850,234857,293924,205370,224311,314235,263088,274359,285972},
		        {291855,355332,340535,323655,223736,360858,308493,291486,257750,337230,288688,217014,349664,259494,257734,309604},
		        {302271,355372,330393,283434,257362,341749,298849,342470,237920,339463,258401,224467,292231,252608,251800,335421},
		        {171051,187763,172680,206659,159913,241588,217729,215788,169143,195899,161876,160362,198572,127611,145126,181286},
		        {274961,315044,340434,353721,183803,401471,296849,281954,229223,282762,207002,219643,337165,277202,237953,274313},
		        {259039,270891,289178,271908,219704,298293,254718,268982,226439,260760,160484,203904,222269,218554,228063,242610},
		        {267316,321475,298007,277740,257551,328165,310245,311028,254009,292522,251945,195664,308631,209531,220439,297351},
		        {210067,255828,237740,234255,192146,270894,271704,252490,223696,253377,192537,221936,243283,235604,243060,232381}};

	static int DATA_3[16][16];

	uint32_t start_time = TMR(ADR_TIMER_BASE);
	
	for(int i = 0; i<FMRS; i++){
		for(int j = 0; j<FMCS; j++){
			FM(i,j) =  DATA_0[i][j];
		}
	}
	
	for(int i = 0; i<FMCS; i++){
		for(int j = 0; j<SMCS; j++){
			SM(i,j) =  DATA_1[i][j];
		}
	}
	
	ACC_IO(ADR_CONTROL_BASE) = DATA_START; // start = 1
	ACC_IO(ADR_CONTROL_BASE) = DATA_STOP; // start = 0
	while(!ACC_IO(ADR_FINISHED)){

	}

	p_int.myuint =  TMR(ADR_TIMER_BASE);
	printk("Finished at(cycle) = %c%c%c%c\n", p_int.myChars.char4,p_int.myChars.char3,p_int.myChars.char2,p_int.myChars.char1);
	p_int.myuint = p_int.myuint - start_time;
	printk("Total count(cycle) = %c%c%c%c\n", p_int.myChars.char4,p_int.myChars.char3,p_int.myChars.char2,p_int.myChars.char1);
	p_int.myuint =  start_time;
	printk("Started at(cycle) = %c%c%c%c\n", p_int.myChars.char4,p_int.myChars.char3,p_int.myChars.char2,p_int.myChars.char1);
	
	for(int i = 0; i<FMRS; i++){
		for(int j = 0; j<SMCS; j++){
			DATA_3[i][j]=(TM(i,j));
		}
	}

	for(int i = 0; i<FMRS; i++){
		for(int j = 0; j<SMCS; j++){
			if(DATA_2[i][j] == DATA_3[i][j]){
				//printk("eq\n");
			}else{
				printk("failed\n");
			}
		}
	}
	
	while(1){
		printk("looping\n");
		GPIO->GPIO_1 = 1;
		k_sleep(K_MSEC(500));
		GPIO->GPIO_1 = 0;
		k_sleep(K_MSEC(500));
	}
}
